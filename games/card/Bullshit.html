<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bullshit - Card Game</title>
    <link rel="icon" href="../../assets/images/icons/ZoodsRoomFaviconTransparent.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap');

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1e3a29; /* Default Green */
            background-image: radial-gradient(#264a34 15%, transparent 16%), radial-gradient(#264a34 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            overflow: hidden;
            user-select: none;
            height: 100vh;
            width: 100vw;
            transition: background-color 0.5s ease;
        }

        /* --- Card Styles --- */
        .card {
            width: 70px;
            height: 100px;
            background-color: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            position: relative;
            display: inline-flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, top 0.2s, box-shadow 0.2s;
            border: 1px solid #ccc;
        }

        @media (min-width: 768px) {
            .card { width: 90px; height: 130px; border-radius: 8px; padding: 8px; }
        }

        .card.red { color: #d00; }
        .card.black { color: #111; }

        .card-corner-top { align-self: flex-start; line-height: 1; text-align: center; }
        .card-corner-bottom { align-self: flex-end; transform: rotate(180deg); line-height: 1; text-align: center; }
        .card-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; }

        /* Card Selection State */
        .card.selected {
            transform: translateY(-20px);
            box-shadow: 0 0 10px 4px rgba(255, 215, 0, 0.6);
            border-color: gold;
            z-index: 10;
        }

        /* --- Card Backs --- */
        .card-back {
            background-color: #3b82f6;
            width: 100%;
            height: 100%;
            border-radius: 5px;
            border: 2px solid white;
        }

        /* Patterns */
        .pattern-classic {
            background: repeating-linear-gradient(45deg, #cc2e2e, #cc2e2e 5px, #ffffff 5px, #ffffff 10px);
        }
        .pattern-blue {
            background: repeating-linear-gradient(45deg, #1e40af, #1e40af 5px, #3b82f6 5px, #3b82f6 10px);
        }
        .pattern-geometric {
            background-color: #111;
            background-image: radial-gradient(white 15%, transparent 16%), radial-gradient(white 15%, transparent 16%);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
        }
        .pattern-luxury {
            background: linear-gradient(135deg, #ffd700 0%, #b8860b 100%);
            border: 2px solid #fff;
        }

        /* --- Player Areas --- */
        .player-hand {
            display: flex;
            justify-content: flex-start; /* Aligned left */
            align-items: center;
            height: 160px;
            margin-top: auto;
        }
        
        .hand-overlap .card {
            margin-left: -35px; /* Overlap cards */
        }
        .hand-overlap .card:first-child { margin-left: 0; }
        .hand-overlap .card:hover { z-index: 20; transform: translateY(-10px); }
        .hand-overlap .card.selected:hover { transform: translateY(-30px); }

        /* --- Animations --- */
        @keyframes deal {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            100% { transform: translate(0, 0) scale(1); opacity: 1; }
        }
        .animate-deal { animation: deal 0.5s ease-out forwards; }

        @keyframes throwIn {
            0% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: translate(var(--tx), var(--ty)) rotate(var(--rot)) scale(1); opacity: 1; }
        }

        /* --- Badges --- */
        .player-badge {
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9rem;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        .active-player .player-badge {
            background: rgba(234, 179, 8, 0.9); /* Yellow-500 */
            color: black;
            box-shadow: 0 0 15px rgba(234, 179, 8, 0.5);
            font-weight: bold;
            transform: scale(1.05);
        }

        /* --- Modals --- */
        .modal-overlay {
            background: rgba(0,0,0,0.85);
            position: fixed; inset: 0; 
            z-index: 200; /* Increased to be above Main Menu (z-100) */
            display: flex; justify-content: center; align-items: center;
        }

        /* --- Main Menu --- */
        #main-menu {
            position: fixed; inset: 0; z-index: 100;
            background-color: transparent; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .title-text {
            font-family: 'Roboto', sans-serif;
            font-weight: 900;
            font-size: 5rem;
            color: #f3f4f6;
            text-shadow: 4px 4px 0px #000, 8px 8px 0px rgba(0,0,0,0.2);
            letter-spacing: -2px;
            margin-bottom: 0.5rem;
        }
        .subtitle-text {
            font-size: 1.5rem;
            color: #fbbf24;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 4px;
            margin-bottom: 3rem;
        }
        
        /* Rank Display Animation */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .pop-anim { animation: pop 0.2s ease-out; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Main Menu -->
    <div id="main-menu">
        <h1 class="title-text">BULLSHIT</h1>
        <p class="subtitle-text">The Game of Deception</p>
        
        <div class="flex flex-col gap-4 w-64">
            <button onclick="game.startGame()" class="bg-yellow-500 hover:bg-yellow-400 text-black font-black py-4 px-8 rounded-lg shadow-xl text-xl transform hover:scale-105 transition border-2 border-yellow-300">
                PLAY GAME
            </button>
            <button onclick="toggleModal('settingsModal')" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg border border-gray-600 transition">
                SETTINGS
            </button>
            <button onclick="toggleModal('helpModal')" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg border border-gray-600 transition">
                HOW TO PLAY
            </button>
        </div>
        
        <div class="absolute bottom-8 text-white/30 text-sm">
            v2.4 ‚Ä¢ Stable Release
        </div>
    </div>

    <!-- Navbar (Hidden on Menu) -->
    <div id="navbar" class="hidden fixed top-0 w-full p-4 flex justify-between items-center z-40 pointer-events-none">
        <div class="pointer-events-auto">
            <button onclick="toggleModal('settingsModal')" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow border border-gray-600">
                <i class="fas fa-cog mr-2"></i> Settings
            </button>
            <button onclick="toggleModal('helpModal')" class="ml-2 bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg shadow border border-gray-600">
                <i class="fas fa-question-circle mr-2"></i> Rules
            </button>
        </div>
        <div class="pointer-events-auto">
             <button onclick="game.exitToMenu()" class="bg-red-800 hover:bg-red-700 text-white px-4 py-2 rounded-lg shadow border border-red-600">
                Exit
            </button>
        </div>
    </div>

    <!-- Game Board (Hidden on Menu) -->
    <div id="game-container" class="hidden relative flex-grow w-full h-full flex flex-col justify-between overflow-hidden p-2">
        
        <!-- Opponents Row - Pushed down (mt-24) to avoid navbar collision -->
        <div class="flex justify-between w-full max-w-5xl mx-auto mt-24 px-4">
            <!-- Visual Slot 1 (Left) -->
            <div id="visual-slot-1" class="flex flex-col items-center transition-all duration-300 opacity-80 w-24">
                <div class="relative w-16 h-24 bg-gray-800 rounded-lg border-2 border-gray-600 shadow-xl flex items-center justify-center mb-2">
                    <span class="text-2xl text-white font-bold" id="slot-1-count">0</span>
                    <div class="absolute -top-2 -right-2 bg-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs text-white border border-white">
                        <i class="fas fa-robot"></i>
                    </div>
                </div>
                <div class="player-badge" id="slot-1-name">Bot 1</div>
                <div id="slot-1-status" class="h-6 text-sm text-yellow-400 font-bold mt-1"></div>
            </div>

            <!-- Visual Slot 2 (Top) -->
            <div id="visual-slot-2" class="flex flex-col items-center transition-all duration-300 opacity-80 w-24">
                <div class="relative w-16 h-24 bg-gray-800 rounded-lg border-2 border-gray-600 shadow-xl flex items-center justify-center mb-2">
                    <span class="text-2xl text-white font-bold" id="slot-2-count">0</span>
                    <div class="absolute -top-2 -right-2 bg-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs text-white border border-white">
                        <i class="fas fa-robot"></i>
                    </div>
                </div>
                <div class="player-badge" id="slot-2-name">Bot 2</div>
                <div id="slot-2-status" class="h-6 text-sm text-yellow-400 font-bold mt-1"></div>
            </div>

            <!-- Visual Slot 3 (Right) -->
            <div id="visual-slot-3" class="flex flex-col items-center transition-all duration-300 opacity-80 w-24">
                <div class="relative w-16 h-24 bg-gray-800 rounded-lg border-2 border-gray-600 shadow-xl flex items-center justify-center mb-2">
                    <span class="text-2xl text-white font-bold" id="slot-3-count">0</span>
                    <div class="absolute -top-2 -right-2 bg-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs text-white border border-white">
                        <i class="fas fa-robot"></i>
                    </div>
                </div>
                <div class="player-badge" id="slot-3-name">Bot 3</div>
                <div id="slot-3-status" class="h-6 text-sm text-yellow-400 font-bold mt-1"></div>
            </div>
        </div>

        <!-- LAYOUT: Current Requirement (Left Side - More padding left-8) -->
        <div class="absolute left-60 top-1/2 transform -translate-y-1/2 z-30 pointer-events-none flex flex-col items-start">
             <div class="bg-black/60 text-white px-6 py-4 rounded-xl backdrop-blur-sm border border-white/20 shadow-2xl text-center pointer-events-auto">
                <div class="text-xs uppercase tracking-widest text-gray-400 mb-1">Current Rank</div>
                <div id="current-rank-display" class="text-5xl font-black text-yellow-400 drop-shadow-md">ACE</div>
            </div>
        </div>

        <!-- LAYOUT: Action Buttons Area (Bottom Right) -->
        <div class="absolute right-40 bottom-8 z-40 pointer-events-none flex flex-col items-end">
             <div id="action-area" class="flex flex-col gap-4 pointer-events-auto items-end">
                <!-- Buttons injected by JS (Play, Bullshit, Believe) -->
            </div>
        </div>

        <!-- Center Area (Pile & Info) - Centered -->
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center z-20 pointer-events-none">
            
            <!-- Discard Pile -->
            <div class="relative w-32 h-44 bg-white/10 border-2 border-dashed border-white/30 rounded-lg flex items-center justify-center pointer-events-auto">
                <span class="text-white/30 text-sm font-bold uppercase tracking-wider">Discard<br>Pile</span>
                <div id="pile-container" class="absolute inset-0 w-full h-full">
                    <!-- Pile cards go here -->
                </div>
                <div id="pile-count-badge" class="absolute -top-3 -right-3 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow border border-white hidden">0</div>
            </div>

            <!-- Action Log / Game Messages -->
            <div id="game-message" class="mt-4 text-white font-bold text-lg text-center h-8 drop-shadow-md pointer-events-auto bg-black/30 px-4 rounded-full backdrop-blur-sm whitespace-nowrap">
                Game Started
            </div>

        </div>

        <!-- User Player Area (Aligned Left) -->
        <div id="player-0" class="flex flex-col items-start w-full pl-8 mb-4 z-20">
            <div class="flex flex-col items-center ml-12">
                <div id="p0-status" class="h-6 text-sm text-yellow-400 font-bold mb-2"></div>
                <div class="player-badge mb-2">You</div>
            </div>
            
            <!-- Hand -->
            <div id="user-hand" class="player-hand hand-overlap w-full overflow-x-visible px-48">
                <!-- User Cards -->
            </div>
            
            <div class="mt-2 text-gray-400 text-xs ml-48">Select 1-4 cards to play</div>
        </div>
    </div>

    <!-- Modals -->

    <!-- Instructions Modal -->
    <div id="helpModal" class="hidden modal-overlay">
        <div class="bg-white text-gray-900 rounded-xl shadow-2xl max-w-lg w-full p-6 mx-4">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-bold text-gray-800">How to Play "Bullshit"</h2>
                <button onclick="toggleModal('helpModal')" class="text-gray-500 hover:text-red-500 text-xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3 text-sm overflow-y-auto max-h-[60vh]">
                <p><strong>Objective:</strong> Be the first player to get rid of all your cards.</p>
                <p><strong>The Flow:</strong></p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>The game proceeds in ranks: Ace, 2, 3, 4... King, Ace...</li>
                    <li>On your turn, you must play 1 to 4 cards face down.</li>
                    <li>You must claim these cards match the Current Rank.</li>
                    <li><strong>Lying:</strong> You can lie! You can play a Jack and claim it's an Ace.</li>
                </ul>
                <p><strong>Calling Bullshit:</strong></p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>After a player moves, opponents can call "Bullshit!" if they think the player is lying.</li>
                    <li>If the player <strong>WAS lying</strong>: They pick up the entire discard pile.</li>
                    <li>If the player <strong>WAS NOT lying</strong>: The challenger picks up the entire discard pile.</li>
                </ul>
                <p><strong>Winning:</strong> The game ends when a player runs out of cards.</p>
            </div>
            <div class="mt-6 text-center">
                <button onclick="toggleModal('helpModal')" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition">Got it!</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden modal-overlay">
        <div class="bg-white text-gray-900 rounded-xl shadow-2xl max-w-md w-full p-6 mx-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Settings</h2>
            
            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Opponent Count</label>
                <div class="flex gap-2">
                    <button onclick="updateBotCount(1)" id="bot-btn-1" class="flex-1 py-2 px-4 rounded border font-bold text-gray-600 hover:bg-gray-100 transition">1 Bot</button>
                    <button onclick="updateBotCount(2)" id="bot-btn-2" class="flex-1 py-2 px-4 rounded border font-bold text-gray-600 hover:bg-gray-100 transition">2 Bots</button>
                    <button onclick="updateBotCount(3)" id="bot-btn-3" class="flex-1 py-2 px-4 rounded border bg-blue-600 text-white font-bold transition">3 Bots</button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Table Color</label>
                <div class="flex gap-2">
                    <button onclick="setTableColor('green')" class="w-8 h-8 rounded-full bg-green-900 border-2 border-white shadow hover:scale-110 transition"></button>
                    <button onclick="setTableColor('blue')" class="w-8 h-8 rounded-full bg-blue-900 border-2 border-gray-300 shadow hover:scale-110 transition"></button>
                    <button onclick="setTableColor('red')" class="w-8 h-8 rounded-full bg-red-900 border-2 border-gray-300 shadow hover:scale-110 transition"></button>
                    <button onclick="setTableColor('purple')" class="w-8 h-8 rounded-full bg-purple-900 border-2 border-gray-300 shadow hover:scale-110 transition"></button>
                    <button onclick="setTableColor('black')" class="w-8 h-8 rounded-full bg-gray-900 border-2 border-gray-300 shadow hover:scale-110 transition"></button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-bold mb-2">Card Back Design</label>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setCardBack('pattern-classic')" class="flex flex-col items-center p-2 border rounded hover:bg-gray-100">
                        <div class="w-12 h-16 rounded border pattern-classic mb-2"></div>
                        <span class="text-xs">Classic Red</span>
                    </button>
                    <button onclick="setCardBack('pattern-blue')" class="flex flex-col items-center p-2 border rounded hover:bg-gray-100">
                        <div class="w-12 h-16 rounded border pattern-blue mb-2"></div>
                        <span class="text-xs">Classic Blue</span>
                    </button>
                    <button onclick="setCardBack('pattern-geometric')" class="flex flex-col items-center p-2 border rounded hover:bg-gray-100">
                        <div class="w-12 h-16 rounded border bg-black mb-2 pattern-geometric"></div>
                        <span class="text-xs">Geometric</span>
                    </button>
                    <button onclick="setCardBack('pattern-luxury')" class="flex flex-col items-center p-2 border rounded hover:bg-gray-100">
                        <div class="w-12 h-16 rounded border pattern-luxury mb-2"></div>
                        <span class="text-xs">Luxury Gold</span>
                    </button>
                </div>
            </div>

            <div class="mt-6 flex justify-end">
                <button onclick="toggleModal('settingsModal')" class="bg-gray-800 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Close</button>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="gameOverModal" class="hidden modal-overlay">
        <div class="bg-white text-gray-900 rounded-xl shadow-2xl max-w-sm w-full p-8 mx-4 text-center transform scale-100 transition-transform">
            <div id="winner-icon" class="text-6xl mb-4 text-yellow-500">üèÜ</div>
            <h2 id="winner-title" class="text-3xl font-extrabold text-gray-800 mb-2">You Win!</h2>
            <p id="winner-message" class="text-gray-600 mb-6">Congratulations on clearing your hand.</p>
            <button onclick="game.startGame()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition transform hover:scale-105">Play Again</button>
            <button onclick="game.exitToMenu()" class="block mt-4 text-gray-500 hover:text-gray-800 text-sm font-bold w-full">Return to Menu</button>
        </div>
    </div>

    <!-- Toast Notification (Floating) -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full shadow-xl opacity-0 transition-opacity duration-300 pointer-events-none z-50 font-bold">
        Error Message
    </div>

    <script>
        // --- Game Constants & Data ---
        const SUITS = ['‚ô†', '‚ô•', '‚ô£', '‚ô¶'];
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const VALUES = {
            'A': 1, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, 
            '8': 8, '9': 9, '10': 10, 'J': 11, 'Q': 12, 'K': 13
        };

        const TABLE_COLORS = {
            green: { bg: '#1e3a29', dot: '#264a34' },
            blue: { bg: '#0f172a', dot: '#1e293b' },
            red: { bg: '#450a0a', dot: '#7f1d1d' },
            purple: { bg: '#3b0764', dot: '#581c87' },
            black: { bg: '#171717', dot: '#262626' }
        };

        // --- Helper Functions ---
        function toggleModal(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        }

        let currentCardBack = 'pattern-classic';
        function setCardBack(patternClass) {
            currentCardBack = patternClass;
            document.querySelectorAll('.card-back').forEach(el => {
                el.className = `card-back ${patternClass}`;
            });
        }

        function setTableColor(color) {
            const c = TABLE_COLORS[color];
            if (c) {
                document.body.style.backgroundColor = c.bg;
                document.body.style.backgroundImage = `radial-gradient(${c.dot} 15%, transparent 16%), radial-gradient(${c.dot} 15%, transparent 16%)`;
            }
        }

        let botCount = 3;

        function updateBotCount(count) {
            botCount = count;
            // Visual update for buttons
            [1, 2, 3].forEach(i => {
                const btn = document.getElementById(`bot-btn-${i}`);
                if (i === count) {
                    btn.className = "flex-1 py-2 px-4 rounded border bg-blue-600 text-white font-bold transition";
                } else {
                    btn.className = "flex-1 py-2 px-4 rounded border font-bold text-gray-600 hover:bg-gray-100 transition";
                }
            });
        }

        function showToast(msg, color = 'bg-red-600') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `fixed top-24 left-1/2 transform -translate-x-1/2 text-white px-6 py-3 rounded-full shadow-xl opacity-100 transition-opacity duration-300 pointer-events-none z-50 font-bold ${color}`;
            setTimeout(() => { t.classList.remove('opacity-100'); t.classList.add('opacity-0'); }, 2000);
        }

        // --- Classes ---

        class Card {
            constructor(suit, rank) {
                this.suit = suit;
                this.rank = rank;
                this.value = VALUES[rank];
                this.color = (suit === '‚ô•' || suit === '‚ô¶') ? 'red' : 'black';
                this.id = Math.random().toString(36).substr(2, 9);
            }

            getHTML(faceUp = true) {
                if (!faceUp) {
                    return `
                        <div class="card" id="${this.id}">
                            <div class="card-back ${currentCardBack}"></div>
                        </div>
                    `;
                }
                return `
                    <div class="card ${this.color}" id="${this.id}" onclick="game.toggleCardSelection('${this.id}')">
                        <div class="card-corner-top">
                            <div>${this.rank}</div>
                            <div>${this.suit}</div>
                        </div>
                        <div class="card-center">${this.suit}</div>
                        <div class="card-corner-bottom">
                            <div>${this.rank}</div>
                            <div>${this.suit}</div>
                        </div>
                    </div>
                `;
            }
        }

        class Deck {
            constructor() {
                this.cards = [];
                for (let s of SUITS) {
                    for (let r of RANKS) {
                        this.cards.push(new Card(s, r));
                    }
                }
            }

            shuffle() {
                // Fisher-Yates shuffle
                for (let i = this.cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [this.cards[i], this.cards[j]] = [this.cards[j], this.cards[i]];
                }
            }

            deal(numPlayers) {
                const hands = Array(numPlayers).fill().map(() => []);
                let i = 0;
                while (this.cards.length > 0) {
                    hands[i % numPlayers].push(this.cards.pop());
                    i++;
                }
                hands.forEach(h => h.sort((a,b) => a.value - b.value));
                return hands;
            }
        }

        class Game {
            constructor() {
                this.players = []; // 0 is user
                this.pile = [];
                this.turnIndex = 0;
                this.currentRankIndex = 0; 
                this.selectedCardIds = new Set();
                this.lastMove = null; 
                this.gameState = 'menu';
                this.activeBotCount = 3;
            }

            exitToMenu() {
                document.getElementById('main-menu').style.display = 'flex';
                document.getElementById('game-container').classList.add('hidden');
                document.getElementById('navbar').classList.add('hidden');
                document.getElementById('gameOverModal').classList.add('hidden');
                this.gameState = 'menu';
            }

            startGame() {
                document.getElementById('main-menu').style.display = 'none';
                document.getElementById('game-container').classList.remove('hidden');
                document.getElementById('navbar').classList.remove('hidden');
                this.restartGame();
            }

            restartGame() {
                document.getElementById('gameOverModal').classList.add('hidden');
                document.getElementById('pile-container').innerHTML = '';
                document.getElementById('pile-count-badge').classList.add('hidden');
                document.getElementById('pile-count-badge').textContent = '0';
                
                this.gameState = 'init';
                this.turnIndex = 0;
                this.currentRankIndex = 0; // Starts at Ace
                this.pile = [];
                this.lastMove = null;
                this.selectedCardIds.clear();
                this.activeBotCount = botCount; // Update from global settings

                const deck = new Deck();
                // Tripple shuffle for good measure
                deck.shuffle();
                deck.shuffle();
                deck.shuffle();

                const totalPlayers = this.activeBotCount + 1;
                const hands = deck.deal(totalPlayers);

                this.players = hands.map((hand, idx) => ({
                    id: idx,
                    name: idx === 0 ? 'You' : `Bot ${idx}`,
                    isBot: idx !== 0,
                    hand: hand
                }));

                this.updateRankDisplay();
                this.updateUI();
                this.startTurn();
            }

            get currentRank() {
                return RANKS[this.currentRankIndex];
            }

            nextRank() {
                this.currentRankIndex = (this.currentRankIndex + 1) % RANKS.length;
                this.updateRankDisplay();
            }

            updateRankDisplay() {
                const r = this.currentRank;
                const name = r === 'A' ? 'ACE' : r === 'K' ? 'KING' : r === 'Q' ? 'QUEEN' : r === 'J' ? 'JACK' : r;
                const el = document.getElementById('current-rank-display');
                el.textContent = name;
                
                // Add pop animation
                const container = el.parentElement;
                container.classList.remove('pop-anim');
                void container.offsetWidth; // trigger reflow
                container.classList.add('pop-anim');
            }

            // Maps logical player index (1,2,3) to visual slot (1=Left, 2=Top, 3=Right)
            getVisualSlot(playerIndex) {
                // Logic based on bot count
                if (this.activeBotCount === 1) {
                    // 1 Bot: Center Top (Slot 2)
                    if (playerIndex === 1) return 2;
                } else if (this.activeBotCount === 2) {
                    // 2 Bots: Left (1) and Right (3)
                    if (playerIndex === 1) return 1;
                    if (playerIndex === 2) return 3;
                } else {
                    // 3 Bots: 1, 2, 3
                    return playerIndex; 
                }
                return 0; // Should not happen
            }

            updateUI() {
                // Hide all bot slots first
                [1,2,3].forEach(slot => {
                    document.getElementById(`visual-slot-${slot}`).classList.add('opacity-0');
                    document.getElementById(`visual-slot-${slot}`).classList.remove('opacity-80', 'opacity-100');
                });

                // Render active opponents
                for (let i = 1; i <= this.activeBotCount; i++) {
                    const visualSlot = this.getVisualSlot(i);
                    const slotDiv = document.getElementById(`visual-slot-${visualSlot}`);
                    
                    slotDiv.classList.remove('opacity-0');
                    
                    // Count
                    document.getElementById(`slot-${visualSlot}-count`).textContent = this.players[i].hand.length;
                    document.getElementById(`slot-${visualSlot}-name`).textContent = this.players[i].name;

                    // Active Player Highlight
                    if (this.turnIndex === i) {
                        slotDiv.classList.add('active-player', 'opacity-100');
                        slotDiv.classList.remove('opacity-80');
                    } else {
                        slotDiv.classList.remove('active-player', 'opacity-100');
                        slotDiv.classList.add('opacity-80');
                    }
                }

                // Update User
                const userDiv = document.getElementById('player-0');
                if (this.turnIndex === 0) {
                    userDiv.classList.add('active-player');
                    document.getElementById('p0-status').textContent = "YOUR TURN";
                } else {
                    userDiv.classList.remove('active-player');
                    document.getElementById('p0-status').textContent = "";
                }

                // Render User Hand
                const handContainer = document.getElementById('user-hand');
                handContainer.innerHTML = '';
                this.players[0].hand.forEach(card => {
                    const cardHTML = card.getHTML(true);
                    handContainer.insertAdjacentHTML('beforeend', cardHTML);
                    const el = document.getElementById(card.id);
                    if (this.selectedCardIds.has(card.id)) {
                        el.classList.add('selected');
                    }
                });

                // Pile Badge
                const pileBadge = document.getElementById('pile-count-badge');
                if (this.pile.length > 0) {
                    pileBadge.textContent = this.pile.length;
                    pileBadge.classList.remove('hidden');
                } else {
                    pileBadge.classList.add('hidden');
                }
            }

            toggleCardSelection(cardId) {
                if (this.gameState !== 'player_turn' || this.turnIndex !== 0) return;

                const el = document.getElementById(cardId);
                if (this.selectedCardIds.has(cardId)) {
                    this.selectedCardIds.delete(cardId);
                    el.classList.remove('selected');
                } else {
                    if (this.selectedCardIds.size >= 4) {
                        showToast("Max 4 cards allowed!");
                        return;
                    }
                    this.selectedCardIds.add(cardId);
                    el.classList.add('selected');
                }
                this.renderUserButtons();
            }

            renderUserButtons() {
                const area = document.getElementById('action-area');
                area.innerHTML = '';

                if (this.gameState === 'player_turn' && this.turnIndex === 0) {
                    const count = this.selectedCardIds.size;
                    const btnClass = count > 0 
                        ? "bg-green-600 hover:bg-green-500 transform hover:scale-105" 
                        : "bg-gray-600 cursor-not-allowed opacity-50";
                    
                    const btn = document.createElement('button');
                    // Bigger play button
                    btn.className = `${btnClass} text-white font-bold py-4 px-10 rounded-full shadow-2xl transition duration-200 z-50 relative pointer-events-auto text-xl border-2 border-green-400`;
                    btn.innerHTML = `Play ${count} ${this.currentRank}${count !== 1 ? "'s" : ""}`;
                    btn.disabled = count === 0;
                    
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.submitMove();
                    });
                    
                    area.appendChild(btn);
                } else if (this.gameState === 'challenge_window' && this.lastMove.playerIndex !== 0) {
                    // Challenge buttons - Bigger
                    const bsBtn = document.createElement('button');
                    bsBtn.className = "bg-red-600 hover:bg-red-500 text-white font-bold py-4 px-10 rounded-full shadow-2xl transition transform hover:scale-105 z-50 relative pointer-events-auto text-xl border-2 border-red-400 mb-2";
                    bsBtn.innerHTML = "<i class='fas fa-exclamation-triangle mr-2'></i>Bullshit!";
                    bsBtn.onclick = () => this.resolveChallenge(true); 

                    const okBtn = document.createElement('button');
                    okBtn.className = "bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-10 rounded-full shadow-2xl transition transform hover:scale-105 z-50 relative pointer-events-auto text-xl border-2 border-blue-400";
                    okBtn.innerHTML = "<i class='fas fa-thumbs-up mr-2'></i>Believe";
                    okBtn.onclick = () => this.resolveChallenge(false);

                    area.appendChild(bsBtn);
                    area.appendChild(okBtn);
                }
            }

            startTurn() {
                this.checkWinCondition();
                if (this.gameState === 'game_over') return;

                this.selectedCardIds.clear();
                this.updateUI();
                this.renderUserButtons();
                
                this.gameState = 'player_turn';
                const player = this.players[this.turnIndex];

                if (player.isBot) {
                    document.getElementById('game-message').textContent = `${player.name} is thinking...`;
                    const visualSlot = this.getVisualSlot(this.turnIndex);
                    if(visualSlot) document.getElementById(`slot-${visualSlot}-status`).textContent = "Thinking...";
                    
                    setTimeout(() => this.botMove(player), 1000 + Math.random() * 1000);
                } else {
                    document.getElementById('game-message').textContent = `Your Turn: Play ${this.currentRank}s`;
                    showToast(`Play ${this.currentRank}s`, 'bg-blue-600');
                }
            }

            submitMove() {
                if (this.selectedCardIds.size === 0) return;
                const cardsToPlay = this.players[0].hand.filter(c => this.selectedCardIds.has(c.id));
                if (cardsToPlay.length === 0) {
                    showToast("Error selecting cards");
                    return;
                }
                this.executeMove(0, cardsToPlay);
            }

            botMove(player) {
                const rankToPlay = this.currentRank;
                const trueCards = player.hand.filter(c => c.rank === rankToPlay);
                let cardsToPlay = [];

                if (trueCards.length > 0) {
                    cardsToPlay = trueCards;
                } else {
                    const randomIndex = Math.floor(Math.random() * player.hand.length);
                    cardsToPlay = [player.hand[randomIndex]];
                }

                if(cardsToPlay.length > 4) cardsToPlay = cardsToPlay.slice(0, 4);

                this.executeMove(this.turnIndex, cardsToPlay);
            }

            executeMove(playerIdx, cards) {
                const player = this.players[playerIdx];
                
                player.hand = player.hand.filter(c => !cards.includes(c));
                this.pile.push(...cards);

                this.lastMove = {
                    playerIndex: playerIdx,
                    declaredCount: cards.length,
                    actualCards: cards,
                    declaredRank: this.currentRank
                };

                // Animate Cards
                this.animateMove(playerIdx, cards.length);

                // ** IMMEDIATELY Update Pile Visuals after animation flight time (600ms) **
                setTimeout(() => {
                    this.updatePileVisuals(); 
                }, 600);

                const msg = `${player.name} played ${cards.length} x ${this.currentRank}${cards.length > 1 ? "'s" : ""}`;
                document.getElementById('game-message').textContent = msg;
                
                if(playerIdx !== 0) {
                     const visualSlot = this.getVisualSlot(playerIdx);
                     document.getElementById(`slot-${visualSlot}-status`).textContent = "";
                }

                this.gameState = 'challenge_window';
                this.updateUI();
                this.renderUserButtons();

                if (player.isBot) {
                    this.checkForBotChallenge();
                } else {
                    setTimeout(() => this.botChallengeDecision(), 1000);
                }
            }
            
            updatePileVisuals() {
                const container = document.getElementById('pile-container');
                container.innerHTML = '';
                if (this.pile.length > 0) {
                    const count = Math.min(this.pile.length, 6); // Max 6 cards shown for mess
                    for(let i=0; i<count; i++) {
                        const div = document.createElement('div');
                        div.className = `card absolute top-1/2 left-1/2 w-20 h-28 transform -translate-x-1/2 -translate-y-1/2 border border-gray-400 rounded bg-white shadow-sm`;
                        div.innerHTML = `<div class="card-back ${currentCardBack}"></div>`;
                        // Random rotation for messy effect
                        const rot = (Math.random() * 30) - 15;
                        const offX = (Math.random() * 10) - 5;
                        const offY = (Math.random() * 10) - 5;
                        div.style.transform = `translate(calc(-50% + ${offX}px), calc(-50% + ${offY}px)) rotate(${rot}deg)`;
                        container.appendChild(div);
                    }
                    const badge = document.getElementById('pile-count-badge');
                    badge.textContent = this.pile.length;
                    badge.classList.remove('hidden');
                }
            }

            checkForBotChallenge() {
                let challenger = null;
                const rankNeeded = this.lastMove.declaredRank;
                const declaredCount = this.lastMove.declaredCount;

                // Loop through active bots
                for (let i = 1; i <= this.activeBotCount; i++) {
                    if (i === this.lastMove.playerIndex) continue;
                    
                    const bot = this.players[i];
                    const knownCards = bot.hand.filter(c => c.rank === rankNeeded).length;
                    
                    if (knownCards + declaredCount > 4) {
                        challenger = i;
                        break;
                    }
                    
                    const chance = declaredCount === 3 ? 0.3 : declaredCount === 4 ? 0.6 : 0.05;
                    if (Math.random() < chance) {
                        challenger = i;
                        break;
                    }
                }

                if (challenger !== null) {
                    setTimeout(() => {
                        showToast(`${this.players[challenger].name} calls Bullshit!`);
                        this.resolveGameLogic(true, challenger);
                    }, 800);
                }
            }

            botChallengeDecision() {
                let challenger = null;
                const rankNeeded = this.lastMove.declaredRank;
                const declaredCount = this.lastMove.declaredCount;

                for (let i = 1; i <= this.activeBotCount; i++) {
                    const bot = this.players[i];
                    const knownCards = bot.hand.filter(c => c.rank === rankNeeded).length;
                    
                    if (knownCards + declaredCount > 4) {
                        challenger = i;
                        break;
                    }
                    if (Math.random() < (declaredCount * 0.15)) {
                        challenger = i;
                        break;
                    }
                }

                if (challenger !== null) {
                    showToast(`${this.players[challenger].name} calls Bullshit!`);
                    this.resolveGameLogic(true, challenger);
                } else {
                    setTimeout(() => this.resolveGameLogic(false, null), 1500);
                }
            }

            resolveChallenge(userCalledBS) {
                if (userCalledBS) {
                    this.resolveGameLogic(true, 0);
                } else {
                    this.resolveGameLogic(false, null);
                }
            }

            resolveGameLogic(isChallenge, challengerIndex) {
                this.gameState = 'resolving';
                document.getElementById('action-area').innerHTML = ''; 

                if (!isChallenge) {
                    this.finishTurn();
                    return;
                }

                const move = this.lastMove;
                const playedCards = move.actualCards;
                const rank = move.declaredRank;
                
                const isLying = !playedCards.every(c => c.rank === rank);
                
                this.revealPile(playedCards);

                setTimeout(() => {
                    if (isLying) {
                        showToast(isChallenge && challengerIndex === 0 ? "Gotcha! They were lying!" : `${this.players[move.playerIndex].name} was Lying!`, 'bg-green-600');
                        this.pickupPile(move.playerIndex);
                    } else {
                        showToast(isChallenge && challengerIndex === 0 ? "Oops! They were honest." : `${this.players[move.playerIndex].name} was Honest!`, 'bg-red-600');
                        this.pickupPile(challengerIndex);
                    }
                    setTimeout(() => this.finishTurn(), 2000);
                }, 1500);
            }

            revealPile(lastCards) {
                const container = document.getElementById('pile-container');
                container.innerHTML = ''; 
                lastCards.forEach((card, i) => {
                    const html = card.getHTML(true);
                    container.insertAdjacentHTML('beforeend', html);
                    const el = document.getElementById(card.id);
                    el.style.position = 'absolute';
                    el.style.left = `${50 + (i*10) - (lastCards.length*5)}%`;
                    el.style.top = '50%';
                    el.style.transform = `translate(-50%, -50%) rotate(${(i-1)*10}deg) scale(1.2)`;
                    el.style.zIndex = 100;
                });
            }

            pickupPile(playerIdx) {
                const player = this.players[playerIdx];
                player.hand.push(...this.pile);
                player.hand.sort((a,b) => a.value - b.value); 
                
                this.pile = [];
                document.getElementById('pile-count-badge').classList.add('hidden');
                document.getElementById('pile-container').innerHTML = '';
                this.updateUI();
            }

            finishTurn() {
                if (this.checkWinCondition()) return;

                this.turnIndex = (this.turnIndex + 1) % (this.activeBotCount + 1);
                this.nextRank();
                
                // Refresh pile visuals
                this.updatePileVisuals();
                
                this.startTurn();
            }

            checkWinCondition() {
                const winner = this.players.find(p => p.hand.length === 0);
                if (winner) {
                    this.gameState = 'game_over';
                    document.getElementById('gameOverModal').classList.remove('hidden');
                    const title = document.getElementById('winner-title');
                    const msg = document.getElementById('winner-message');
                    const icon = document.getElementById('winner-icon');
                    
                    if (winner.id === 0) {
                        title.textContent = "You Win!";
                        title.className = "text-3xl font-extrabold text-green-600 mb-2";
                        msg.textContent = "You are the master of deception!";
                        icon.textContent = "üèÜ";
                    } else {
                        title.textContent = "You Lose!";
                        title.className = "text-3xl font-extrabold text-red-600 mb-2";
                        msg.textContent = `${winner.name} emptied their hand first.`;
                        icon.textContent = "üíÄ";
                    }
                    return true;
                }
                return false;
            }

            animateMove(playerIdx, cardCount) {
                const container = document.getElementById('pile-container');
                let startRect;

                if (playerIdx === 0) {
                    startRect = document.getElementById('user-hand').getBoundingClientRect();
                } else {
                    const visualSlot = this.getVisualSlot(playerIdx);
                    startRect = document.getElementById(`visual-slot-${visualSlot}`).getBoundingClientRect();
                }
                
                const endRect = container.getBoundingClientRect();

                for(let i=0; i<cardCount; i++) {
                    const el = document.createElement('div');
                    el.className = `card fixed z-50`;
                    el.innerHTML = `<div class="card-back ${currentCardBack}"></div>`;
                    el.style.left = `${startRect.left + (startRect.width/2)}px`;
                    el.style.top = `${startRect.top + (startRect.height/2)}px`;
                    el.style.transform = `translate(-50%, -50%) scale(0.5)`;
                    document.body.appendChild(el);

                    setTimeout(() => {
                        el.style.transition = "all 0.5s ease-out";
                        el.style.left = `${endRect.left + (endRect.width/2)}px`;
                        el.style.top = `${endRect.top + (endRect.height/2)}px`;
                        el.style.transform = `translate(-50%, -50%) rotate(${Math.random()*360}deg) scale(0.8)`;
                        el.style.opacity = 0;
                    }, 50 * i);

                    setTimeout(() => el.remove(), 600);
                }
            }
        }

        const game = new Game();
    </script>
</body>
</html>