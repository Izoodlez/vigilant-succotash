<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Real-time emergency dashboard for Lebanon County, PA. Monitoring weather, traffic, and public safety frequencies.">
    <meta property="og:title" content="Lebanon County Dashboard">
    <meta property="og:description" content="Real-time emergency dashboard including live CAD, radar, and scanner feeds.">
    <title>Lebanon County Dashboard</title>
    
    <!-- Dynamic Favicon (SVG) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2310b981' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242'/><path d='M16 14v6'/><path d='M8 14v6'/><path d='M12 16v6'/></svg>">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        emerald: { 450: '#10b981' } 
                    },
                    fontFamily: {
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #020617; color: #e2e8f0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Iframe Scaling Class for Dispatch Log */
        .iframe-scaler {
            width: 142.85%; /* 100 / 0.7 */
            height: 142.85%;
            transform: scale(0.7);
            transform-origin: 0 0;
            border: none;
        }

        /* Range Slider Styling */
        input[type=range] {
            /* stylelint-disable-next-line property-no-vendor-prefix */
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            background: transparent;
        }
        
        input[type=range]::-webkit-slider-thumb {
            /* stylelint-disable-next-line property-no-vendor-prefix */
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
            box-shadow: 0 0 4px rgba(16, 185, 129, 0.5);
        }
        
        input[type=range]::-moz-range-thumb {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 4px rgba(16, 185, 129, 0.5);
        }

        input[type=range]:focus {
            outline: none;
        }
    </style>
</head>
<body>
    
    <div id="root" class="h-screen w-screen overflow-hidden"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icon = ({ path, size = 20, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );

        const Icons = {
            CloudRain: <Icon path={<><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M16 14v6"/><path d="M8 14v6"/><path d="M12 16v6"/></>} />,
            Map: <Icon path={<><polygon points="3 6 9 12 15 6 21 12 21 21 15 15 9 21 3 15 3 6"/><line x1="9" x2="9" y1="21" y2="12"/><line x1="15" x2="15" y1="6" y2="15"/></>} />,
            Search: <Icon path={<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>} />,
            Volume2: <Icon path={<><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></>} />,
            BookOpen: <Icon path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            Edit3: <Icon path={<><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></>} />,
            X: <Icon path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            AlertTriangle: <Icon path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} />,
            Trash2: <Icon path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            ExternalLink: <Icon path={<><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></>} />,
            Play: <Icon path={<polygon points="5 3 19 12 5 21 5 3"/>} />,
            Pause: <Icon path={<><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></>} />,
            RefreshCw: <Icon path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></>} />,
        };

        // --- CONSTANTS ---
        const CODES_DATA = {
            "EMS Patient Class": {
                "Class 1": "Immediately Life Threatening (ALS)",
                "Class 2": "Potentially Life Threatening (BLS)",
                "Class 3": "Non-Life Threatening (Routine)",
                "Class 4": "Psychiatric / Behavioral",
                "Class 5": "Deceased / Coroner",
            },
            "Common 10-Codes": {
                "10-4": "Message Received / OK",
                "10-9": "Repeat Message",
                "10-23": "Arrived at Scene",
                "10-45": "Vehicle Accident",
                "10-76": "Enroute to location",
                "10-33": "Emergency Traffic Only",
                "10-44": "Request for Assistance",
                "10-48": "Ambulance Transfer",
            }
        };

        // --- COMPONENTS ---

        const WeatherTicker = () => {
            const [alerts, setAlerts] = useState([]);
            
            useEffect(() => {
                const fetchWeather = async () => {
                    try {
                        const res = await fetch('https://api.weather.gov/alerts/active?zone=PAZ059');
                        if (!res.ok) throw new Error('Weather API error');
                        const data = await res.json();
                        setAlerts(data.features || []);
                    } catch (e) {
                        console.error("Weather alert fetch failed:", e);
                        setAlerts([]);
                    }
                };
                fetchWeather();
            }, []);

            if (alerts.length === 0) return null;

            return (
                <div className="bg-red-900/40 border-b border-red-500/30 text-red-100 text-xs py-2 px-4 flex items-center justify-center gap-2 flex-shrink-0">
                    <span className="text-red-500 animate-pulse">{Icons.AlertTriangle}</span>
                    <span className="font-bold">ALERT:</span>
                    <span className="truncate max-w-screen-md">{alerts[0].properties.headline}</span>
                </div>
            );
        };

        const AudioPlayer = ({ title, streamId }) => {
            const [isPlaying, setIsPlaying] = useState(false);
            const [volume, setVolume] = useState(1);
            const audioRef = useRef(null);

            const togglePlay = () => {
                if(!audioRef.current) return;
                if(isPlaying) {
                    audioRef.current.pause();
                    setIsPlaying(false);
                } else {
                    audioRef.current.play()
                        .then(() => setIsPlaying(true))
                        .catch(e => {
                            console.error("Audio play error:", e);
                            setIsPlaying(false);
                        });
                }
            };

            const handleVolumeChange = (e) => {
                const newVol = parseFloat(e.target.value);
                setVolume(newVol);
                if(audioRef.current) {
                    audioRef.current.volume = newVol;
                }
            };

            return (
                <div className="bg-slate-800 rounded-xl border border-slate-700 p-3 flex flex-col justify-between shadow-lg relative overflow-hidden group min-h-[140px]">
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-emerald-500 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    
                    <audio 
                        ref={audioRef} 
                        src={`https://broadcastify.cdnstream1.com/${streamId}`} 
                        preload="none"
                    />

                    <div className="text-center w-full mb-1">
                        <h3 className="font-bold text-slate-200 text-xs truncate">{title}</h3>
                        <p className="text-[9px] text-slate-400 uppercase tracking-widest mt-0.5">{isPlaying ? "Receiving Feed" : "Feed Offline"}</p>
                    </div>

                    <div className="flex items-center gap-2 w-full px-1 mb-2">
                         <div className={`text-slate-500 transition-colors ${isPlaying ? 'text-emerald-400' : ''}`}>
                            {React.cloneElement(Icons.Volume2, { size: 16 })}
                        </div>
                        <input 
                            type="range" 
                            min="0" 
                            max="1" 
                            step="0.05" 
                            value={volume}
                            onChange={handleVolumeChange}
                            className="w-full h-1.5 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-emerald-500 hover:accent-emerald-400"
                        />
                    </div>

                    <button 
                        onClick={togglePlay}
                        className={`w-full py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 transition-all ${
                            isPlaying 
                            ? 'bg-slate-700 text-red-400 border border-slate-600 hover:bg-slate-600' 
                            : 'bg-emerald-600 text-white hover:bg-emerald-500 shadow-lg shadow-emerald-900/20'
                        }`}
                    >
                        {isPlaying ? <>{Icons.Pause} Stop</> : <>{Icons.Play} Listen</>}
                    </button>
                </div>
            );
        };

        const ReferenceModal = ({ onClose }) => (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={onClose}>
                <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-2xl max-h-[80vh] flex flex-col shadow-2xl" onClick={e => e.stopPropagation()}>
                    <div className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-850 rounded-t-2xl">
                        <h2 className="font-bold text-slate-100 flex items-center gap-2">
                            <span className="text-emerald-500">{Icons.BookOpen}</span> Reference Codes
                        </h2>
                        <button onClick={onClose} className="text-slate-400 hover:text-white p-2">{Icons.X}</button>
                    </div>
                    <div className="p-6 overflow-y-auto grid md:grid-cols-2 gap-8">
                        {Object.entries(CODES_DATA).map(([cat, items]) => (
                            <div key={cat}>
                                <h3 className="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-4 border-b border-emerald-900/30 pb-2">{cat}</h3>
                                <ul className="space-y-3">
                                    {Object.entries(items).map(([code, desc]) => (
                                        <li key={code} className="flex justify-between text-xs group">
                                            <span className="font-mono font-bold text-blue-400 bg-blue-900/20 px-1.5 py-0.5 rounded group-hover:bg-blue-900/40 transition-colors">{code}</span>
                                            <span className="text-slate-400 text-right pl-4">{desc}</span>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const NotepadModal = ({ onClose }) => {
            const [text, setText] = useState(localStorage.getItem('notes') || '');
            const handleChange = (e) => {
                setText(e.target.value);
                localStorage.setItem('notes', e.target.value);
            };

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4" onClick={onClose}>
                    <div className="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-lg shadow-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="p-4 bg-slate-850 border-b border-slate-800 flex justify-between items-center">
                            <h2 className="font-bold text-slate-100 flex items-center gap-2">
                                <span className="text-yellow-500">{Icons.Edit3}</span> Scratchpad
                            </h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white p-2">{Icons.X}</button>
                        </div>
                        <textarea 
                            className="w-full h-64 bg-slate-950 p-4 text-sm text-slate-300 focus:outline-none font-mono leading-relaxed resize-none"
                            placeholder="Type notes, license plates, or addresses here..."
                            value={text}
                            onChange={handleChange}
                        />
                        <div className="p-2 bg-slate-850 border-t border-slate-800 flex justify-end">
                            <button onClick={() => { setText(''); localStorage.setItem('notes', ''); }} className="text-xs text-red-400 flex items-center gap-1 hover:text-red-300 px-3 py-1">
                                {Icons.Trash2} Clear
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const MainApp = () => {
            const [view, setView] = useState('windy');
            const [cadView, setCadView] = useState('lebanon');
            const [location, setLocation] = useState('Lebanon, PA');
            const [searchVal, setSearchVal] = useState('');
            const [showRef, setShowRef] = useState(false);
            const [showNote, setShowNote] = useState(false);
            const [cadRefreshKey, setCadRefreshKey] = useState(0);

            const handleSearch = (e) => {
                e.preventDefault();
                if(searchVal.trim()) setLocation(searchVal);
            };

            return (
                <div className="h-full w-full flex flex-col bg-slate-950 overflow-hidden">
                    <WeatherTicker />

                    {/* Header Controls */}
                    <div className="p-4 pb-2 shrink-0">
                        <div className="bg-slate-900 border border-slate-800 rounded-2xl p-3 flex flex-col md:flex-row items-center justify-between gap-4 shadow-xl">
                            
                            {/* Left: Branding & Toggles */}
                            <div className="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                                <div className="flex items-center gap-2">
                                    <div className="w-10 h-10 bg-slate-800 rounded-xl flex items-center justify-center border border-slate-700 text-emerald-500 shadow-inner">
                                        {view === 'windy' ? Icons.CloudRain : Icons.Map}
                                    </div>
                                    <div className="flex flex-col">
                                        <h1 className="font-bold text-slate-100 text-sm tracking-wide">EMS SCANNER</h1>
                                        <span className="text-[10px] text-slate-500 font-mono">DASHBOARD v2.0</span>
                                    </div>
                                </div>
                                
                                <div className="flex bg-slate-950 p-1 rounded-lg border border-slate-800">
                                    <button onClick={() => setView('windy')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-colors ${view === 'windy' ? 'bg-emerald-600 text-white' : 'text-slate-500 hover:text-slate-300'}`}>Radar</button>
                                    <button onClick={() => setView('google')} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-colors ${view === 'google' ? 'bg-blue-600 text-white' : 'text-slate-500 hover:text-slate-300'}`}>Map</button>
                                </div>
                            </div>

                            {/* Right: Search & Tools */}
                            <div className="flex items-center gap-2 w-full md:w-auto">
                                <form onSubmit={handleSearch} className={`relative group transition-all duration-300 flex-1 ${view === 'google' ? 'opacity-100' : 'opacity-0 pointer-events-none w-0 overflow-hidden'}`}>
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500">
                                        {React.cloneElement(Icons.Search, { size: 14 })}
                                    </div>
                                    <input 
                                        type="text" 
                                        placeholder="Search location..." 
                                        className="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded-lg py-2 pl-9 pr-3 focus:outline-none focus:border-blue-500 transition-all"
                                        value={searchVal}
                                        onChange={e => setSearchVal(e.target.value)}
                                    />
                                </form>

                                <div className="h-8 w-px bg-slate-800 mx-2 hidden md:block"></div>

                                <button onClick={() => setShowNote(true)} className="p-2.5 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 hover:text-yellow-400 hover:border-yellow-900/50 transition-all" title="Notes">
                                    {React.cloneElement(Icons.Edit3, { size: 18 })}
                                </button>
                                <button onClick={() => setShowRef(true)} className="p-2.5 rounded-lg bg-slate-800 border border-slate-700 text-slate-400 hover:text-emerald-400 hover:border-emerald-900/50 transition-all" title="Codes">
                                    {React.cloneElement(Icons.BookOpen, { size: 18 })}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Content Grid */}
                    <div className="flex-1 px-4 pb-4 flex flex-col lg:flex-row gap-4 overflow-hidden min-h-0">
                        
                        {/* LEFT PANE: Map/Radar (Fills remaining height) */}
                        <div className="w-full lg:w-7/12 flex-grow bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden shadow-2xl relative">
                             {view === 'windy' && (
                                <iframe 
                                    className="w-full h-full"
                                    src="https://embed.windy.com/embed2.html?lat=40.340&lon=-76.411&detailLat=40.340&detailLon=-76.411&width=650&height=450&zoom=10&level=surface&overlay=radar&product=radar&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1"
                                    frameBorder="0"
                                    loading="lazy"
                                ></iframe>
                            )}
                            {view === 'google' && (
                                <iframe 
                                    className="w-full h-full"
                                    src={`https://maps.google.com/maps?q=${encodeURIComponent(location)}&t=&z=13&ie=UTF8&iwloc=&output=embed`}
                                    frameBorder="0"
                                    loading="lazy"
                                    allowFullScreen
                                    referrerPolicy="no-referrer-when-downgrade"
                                ></iframe>
                            )}
                        </div>

                        {/* RIGHT PANE: CAD & Audio */}
                        <div className="w-full lg:w-5/12 flex flex-col gap-4 h-full min-h-0">
                            
                            {/* CAD Monitor Box (Fills remaining height) */}
                            <div className="flex-1 bg-white rounded-2xl overflow-hidden border border-slate-700 shadow-xl flex flex-col">
                                <div className="bg-slate-900 text-slate-400 text-[10px] px-2 py-1 flex justify-between items-center border-b border-slate-800 flex-shrink-0">
                                    <div className="flex items-center gap-2">
                                        <span className="font-bold">LIVE CAD - {cadView === 'lebanon' ? 'LEBANON CO.' : 'DAUPHIN CO.'}</span>
                                        <button 
                                            onClick={() => setCadRefreshKey(prev => prev + 1)}
                                            className="text-slate-400 hover:text-emerald-400 transition-colors"
                                            title="Refresh Feed"
                                        >
                                            {React.cloneElement(Icons.RefreshCw, { size: 12 })}
                                        </button>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="flex bg-slate-950 p-1 rounded-lg border border-slate-700">
                                            <button onClick={() => setCadView('lebanon')} className={`px-3 py-1 rounded-md text-[9px] font-bold transition-colors ${cadView === 'lebanon' ? 'bg-emerald-600 text-white' : 'text-slate-500 hover:text-slate-300'}`}>Lebanon</button>
                                            <button onClick={() => setCadView('dauphin')} className={`px-3 py-1 rounded-md text-[9px] font-bold transition-colors ${cadView === 'dauphin' ? 'bg-blue-600 text-white' : 'text-slate-500 hover:text-slate-300'}`}>Dauphin</button>
                                        </div>
                                        <a href={cadView === 'lebanon' ? 'https://www.lcdes.org/monitor.html' : 'https://dpswebcad.dauphincounty.gov/webcad/'} target="_blank" rel="noopener noreferrer" className="hover:text-white flex items-center gap-1">
                                            Open External {React.cloneElement(Icons.ExternalLink, { size: 10 })}
                                        </a>
                                    </div>
                                </div>
                                <div className="flex-1 bg-slate-100 overflow-hidden relative">
                                    <iframe
                                        key={`${cadView}-${cadRefreshKey}`}
                                        src={cadView === 'lebanon' ? 'https://www.lcdes.org/monitor.html' : 'https://dpswebcad.dauphincounty.gov/webcad/'}
                                        className={cadView === 'lebanon' ? 'iframe-scaler' : 'w-full h-full'}
                                        loading="lazy"
                                    />
                                </div>
                            </div>

                            {/* Audio Players - Fixed Height */}
                            <div className="grid grid-cols-2 gap-4 h-auto shrink-0">
                                <AudioPlayer title="Lebanon Co. Safety" streamId="1456" />
                                <AudioPlayer title="Dauphin Co. Safety" streamId="27956" />
                            </div>
                        </div>
                    </div>

                    {/* Modals */}
                    {showRef && <ReferenceModal onClose={() => setShowRef(false)} />}
                    {showNote && <NotepadModal onClose={() => setShowNote(false)} />}

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>