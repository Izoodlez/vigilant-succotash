<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cee-Lo: Street Dice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto+Mono:wght@500&display=swap');

        body {
            background-color: #0f172a;
            color: white;
            font-family: 'Roboto Mono', monospace;
            overflow: hidden;
            touch-action: manipulation;
        }

        /* Felt Table Texture */
        .felt-bg {
            box-shadow: inset 0 0 100px #000;
            transition: background 0.5s ease;
        }

        /* Color Themes */
        .theme-green { background: radial-gradient(circle at center, #276337 0%, #1a4226 100%); }
        .theme-blue { background: radial-gradient(circle at center, #1e40af 0%, #172554 100%); }
        .theme-red { background: radial-gradient(circle at center, #991b1b 0%, #450a0a 100%); }
        .theme-purple { background: radial-gradient(circle at center, #7e22ce 0%, #3b0764 100%); }
        .theme-black { background: radial-gradient(circle at center, #334155 0%, #0f172a 100%); }

        /* 3D Dice Styling */
        .die {
            width: 80px; /* Larger for 3 dice */
            height: 80px;
            background: #f8fafc;
            border-radius: 12px;
            box-shadow: 
                inset 2px 2px 5px rgba(255,255,255,0.8),
                inset -2px -2px 5px rgba(0,0,0,0.2),
                2px 4px 6px rgba(0,0,0,0.4);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            border: 3px solid transparent;
        }

        .die-small {
            width: 50px;
            height: 50px;
            border-radius: 8px;
        }

        /* Highlight States */
        .die.highlight-gold {
            border-color: #f59e0b;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.6), inset 2px 2px 5px rgba(255,255,255,0.8);
            transform: scale(1.15) translateY(-5px);
            z-index: 10;
        }
        
        .die.highlight-green {
            border-color: #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.6), inset 2px 2px 5px rgba(255,255,255,0.8);
            transform: scale(1.15) translateY(-5px);
            z-index: 10;
        }
        
        .die.highlight-red {
            border-color: #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.6), inset 2px 2px 5px rgba(255,255,255,0.8);
        }

        .die.dimmed {
            opacity: 0.4;
            transform: scale(0.9);
            filter: grayscale(0.5);
        }

        .dot {
            width: 14px;
            height: 14px;
            background: #1e293b;
            border-radius: 50%;
            box-shadow: inset 1px 1px 2px rgba(0,0,0,0.5);
            align-self: center;
            justify-self: center;
        }
        
        .die-small .dot {
            width: 8px;
            height: 8px;
        }

        /* Die Faces Grid System (Standard 3x3) */
        [class^="face-"] {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            width: 100%;
            height: 100%;
            padding: 8px;
        }
        
        .die-small [class^="face-"] {
            padding: 4px;
        }

        /* Face Logic */
        .face-1 .dot:nth-child(1) { grid-area: 2 / 2; }
        .face-2 .dot:nth-child(1) { grid-area: 1 / 1; } .face-2 .dot:nth-child(2) { grid-area: 3 / 3; }
        .face-3 .dot:nth-child(1) { grid-area: 1 / 1; } .face-3 .dot:nth-child(2) { grid-area: 2 / 2; } .face-3 .dot:nth-child(3) { grid-area: 3 / 3; }
        .face-4 .dot:nth-child(1) { grid-area: 1 / 1; } .face-4 .dot:nth-child(2) { grid-area: 1 / 3; } .face-4 .dot:nth-child(3) { grid-area: 3 / 1; } .face-4 .dot:nth-child(4) { grid-area: 3 / 3; }
        .face-5 .dot:nth-child(1) { grid-area: 1 / 1; } .face-5 .dot:nth-child(2) { grid-area: 1 / 3; } .face-5 .dot:nth-child(3) { grid-area: 2 / 2; } .face-5 .dot:nth-child(4) { grid-area: 3 / 1; } .face-5 .dot:nth-child(5) { grid-area: 3 / 3; }
        .face-6 .dot:nth-child(1) { grid-area: 1 / 1; } .face-6 .dot:nth-child(2) { grid-area: 1 / 3; } .face-6 .dot:nth-child(3) { grid-area: 2 / 1; } .face-6 .dot:nth-child(4) { grid-area: 2 / 3; } .face-6 .dot:nth-child(5) { grid-area: 3 / 1; } .face-6 .dot:nth-child(6) { grid-area: 3 / 3; }

        .rolling {
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0% { transform: rotate(0deg) translate(0, 0); }
            25% { transform: rotate(5deg) translate(2px, 2px); }
            50% { transform: rotate(0deg) translate(0, -2px); }
            75% { transform: rotate(-5deg) translate(-2px, 2px); }
            100% { transform: rotate(0deg) translate(0, 0); }
        }

        /* --- UI BUTTONS --- */
        .btn-primary {
            background: linear-gradient(to bottom, #f59e0b, #d97706);
            border: 1px solid #b45309;
            color: #fff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
            box-shadow: 0 4px 0 #92400e, 0 5px 10px rgba(0,0,0,0.3);
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:hover { transform: translateY(-2px); background: linear-gradient(to bottom, #fbbf24, #b45309); }
        .btn-primary:active { transform: translateY(4px); box-shadow: 0 0 0 #92400e, inset 0 2px 4px rgba(0,0,0,0.4); }
        .btn-primary:disabled { background: #94a3b8; border-color: #64748b; box-shadow: none; cursor: not-allowed; transform: translateY(2px); }

        .btn-secondary {
            background: linear-gradient(to bottom, #334155, #1e293b);
            border: 1px solid #475569;
            color: #e2e8f0;
            box-shadow: 0 4px 0 #0f172a, 0 5px 10px rgba(0,0,0,0.3);
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-secondary:hover { transform: translateY(-2px); background: linear-gradient(to bottom, #475569, #334155); }
        .btn-secondary:active { transform: translateY(4px); box-shadow: 0 0 0 #0f172a, inset 0 2px 4px rgba(0,0,0,0.5); }
        
        .poker-text { font-family: 'Playfair Display', serif; }
        .modal { backdrop-filter: blur(5px); background: rgba(0,0,0,0.7); }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

        /* Confetti Canvas */
        #confettiCanvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50;
        }
        
        .animate-fade-up { animation: fadeUp 0.3s ease-out forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Badge Styles for Hands */
        .badge-456 { background-color: #22c55e; color: black; box-shadow: 0 0 10px #22c55e; }
        .badge-trips { background-color: #3b82f6; color: white; box-shadow: 0 0 10px #3b82f6; }
        .badge-point { background-color: #f59e0b; color: black; box-shadow: 0 0 5px #f59e0b; }
        .badge-123 { background-color: #ef4444; color: white; box-shadow: 0 0 10px #ef4444; }

        /* VS Panel Dashboard */
        .vs-panel {
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 1rem auto;
            padding: 0.75rem 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .vs-player-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 120px;
        }
        .vs-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #94a3b8;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        .vs-score {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: all 0.3s ease;
        }
        .vs-score.active-score {
            color: #fbbf24;
            transform: scale(1.1);
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }
        .vs-divider {
            font-family: 'Playfair Display', serif;
            font-style: italic;
            color: #64748b;
            font-size: 1.2rem;
            padding: 0 1rem;
        }

    </style>
</head>
<body class="h-screen w-screen flex flex-col felt-bg select-none text-white">

    <canvas id="confettiCanvas"></canvas>

    <!-- Main Menu -->
    <div id="mainMenu" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/80 transition-opacity duration-300">
        <div class="mb-4 flex gap-4">
            <div class="die"><div class="face-4 w-full h-full"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
            <div class="die"><div class="face-5 w-full h-full"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
            <div class="die"><div class="face-6 w-full h-full"><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
        </div>
        <h1 class="text-6xl text-amber-400 poker-text mb-2 text-shadow-lg text-center drop-shadow-lg">Cee-Lo</h1>
        <p class="text-slate-400 mb-8 font-mono tracking-widest text-sm">STREET DICE</p>
        
        <div class="space-y-4 w-64">
            <button onclick="startGame('single')" class="btn-primary w-full py-3 rounded text-xl font-bold tracking-wider">VS BANKER</button>
            <button onclick="startGame('coop')" class="btn-primary w-full py-3 rounded text-xl font-bold tracking-wider">2 PLAYER VS</button>
            <button onclick="toggleSettings()" class="btn-secondary w-full py-2 rounded text-lg font-bold tracking-wider">SETTINGS</button>
        </div>
        
        <!-- Quick Rules -->
        <div class="mt-8 bg-slate-800/50 p-4 rounded text-xs text-slate-400 max-w-sm text-center border border-white/5">
            <span class="text-amber-500 font-bold block mb-1">HAND RANKINGS</span>
            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-left">
                <div>1. <span class="text-green-400">4-5-6</span> (Auto Win)</div>
                <div>3. <span class="text-amber-400">Point</span> (Pair + N)</div>
                <div>2. <span class="text-blue-400">Trips</span> (Ex: 3-3-3)</div>
                <div>4. <span class="text-red-400">1-2-3</span> (Auto Loss)</div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="hidden absolute inset-0 z-50 flex items-center justify-center modal">
        <div class="bg-slate-800 p-8 rounded-xl border border-slate-600 shadow-2xl w-full max-w-md">
            <h2 class="text-3xl poker-text text-amber-400 mb-6 text-center border-b border-slate-600 pb-2">Settings</h2>
            
            <div class="mb-6">
                <span class="text-sm text-slate-400 mb-2 block">Table Color</span>
                <div class="flex justify-between gap-2">
                    <button onclick="setTableColor('green')" class="w-10 h-10 rounded-full bg-green-800 border-2 border-slate-500 hover:scale-110 transition-transform"></button>
                    <button onclick="setTableColor('blue')" class="w-10 h-10 rounded-full bg-blue-800 border-2 border-slate-500 hover:scale-110 transition-transform"></button>
                    <button onclick="setTableColor('red')" class="w-10 h-10 rounded-full bg-red-800 border-2 border-slate-500 hover:scale-110 transition-transform"></button>
                    <button onclick="setTableColor('purple')" class="w-10 h-10 rounded-full bg-purple-800 border-2 border-slate-500 hover:scale-110 transition-transform"></button>
                    <button onclick="setTableColor('black')" class="w-10 h-10 rounded-full bg-slate-800 border-2 border-slate-500 hover:scale-110 transition-transform"></button>
                </div>
            </div>

            <button onclick="toggleSettings()" class="btn-secondary w-full py-2 rounded text-white font-bold">CLOSE</button>
        </div>
    </div>

    <!-- Match Win Modal -->
    <div id="matchWinModal" class="hidden absolute inset-0 z-50 flex items-center justify-center modal">
        <div class="bg-slate-900/95 p-10 rounded-2xl border-4 border-amber-500 shadow-2xl w-full max-w-lg flex flex-col items-center">
            <h2 class="text-5xl poker-text text-amber-400 mb-4 text-center animate-pulse">VICTORY!</h2>
            <div id="matchWinnerName" class="text-3xl font-bold text-white mb-8 text-center tracking-widest">PLAYER 1</div>
            <button onclick="quitGame()" class="py-3 px-8 bg-red-800 hover:bg-red-700 rounded text-white font-bold text-lg shadow-lg">RETURN TO MENU</button>
        </div>
    </div>

    <!-- Game UI -->
    <div id="gameUI" class="hidden flex-1 flex flex-col relative z-10 w-full h-full overflow-hidden">
        
        <!-- Top Bar -->
        <div class="w-full p-4 flex justify-between items-start bg-black/30 backdrop-blur-sm border-b border-white/10 shrink-0 z-20">
            <button onclick="quitGame()" class="px-3 py-1 bg-red-900/50 hover:bg-red-900 rounded text-xs text-red-200 border border-red-800 transition-colors">EXIT</button>
            
            <div class="text-center">
                <div id="modeDisplay" class="text-xs text-amber-400 uppercase tracking-widest font-bold">VS BANKER</div>
                <div id="scoreDisplay" class="text-xl font-bold text-white mt-1">BANK: 100</div>
            </div>

            <button onclick="toggleSettings()" class="px-3 py-1 bg-slate-700/50 hover:bg-slate-700 rounded text-xs text-slate-300 border border-slate-600 transition-colors">OPTS</button>
        </div>

        <!-- Main Area -->
        <div class="flex-1 flex flex-col lg:flex-row w-full gap-4 p-4 overflow-hidden items-stretch">
            
            <!-- Game Board -->
            <div class="flex-1 flex flex-col items-center justify-center relative min-h-0">
                
                <!-- NEW Persistent VS Dashboard -->
                <div id="vsPanel" class="vs-panel mb-4 opacity-0 transition-opacity duration-500">
                    <div class="vs-player-box">
                        <span class="vs-label">PLAYER</span>
                        <div id="p1ScoreBoard" class="vs-score text-slate-500">WAITING</div>
                    </div>
                    <div class="vs-divider">vs</div>
                    <div class="vs-player-box">
                        <span id="p2Label" class="vs-label">BANKER</span>
                        <div id="p2ScoreBoard" class="vs-score text-slate-500">WAITING</div>
                    </div>
                </div>

                <!-- Opponent Dice (Small) -->
                <div id="opponentArea" class="hidden mb-6 flex flex-col items-center animate-fade-up">
                    <div id="opponentDice" class="flex gap-4 opacity-50">
                        <div class="die die-small"><div class="face-1 w-full h-full"><div class="dot"></div></div></div>
                        <div class="die die-small"><div class="face-1 w-full h-full"><div class="dot"></div></div></div>
                        <div class="die die-small"><div class="face-1 w-full h-full"><div class="dot"></div></div></div>
                    </div>
                </div>

                <!-- Info Message Area (Action Prompts) -->
                <div id="messageArea" class="flex flex-col items-center justify-center text-center mb-6 h-16">
                    <span id="gameStatus" class="text-sm text-slate-400 font-bold tracking-widest uppercase block mb-1">PLACE BET</span>
                    <span id="gameResult" class="text-2xl font-bold text-white drop-shadow-md"></span>
                </div>

                <!-- Player Dice -->
                <div class="flex items-center justify-center w-full min-h-[120px] mb-8">
                    <div id="diceContainer" class="flex gap-6 md:gap-8">
                        <!-- Dice Injected Here -->
                    </div>
                </div>

                <!-- Controls -->
                <div class="mt-auto w-full max-w-xl bg-black/40 p-6 rounded-xl backdrop-blur-md border border-white/10 shrink-0">
                    
                    <!-- Betting Controls -->
                    <div id="betControls" class="flex flex-col items-center mb-6 transition-all">
                        <div class="flex items-center gap-6">
                            <button onclick="adjustBet(-10)" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center font-bold text-2xl">-</button>
                            <div class="bg-black/50 px-8 py-3 rounded-lg border border-slate-600 min-w-[120px] text-center">
                                <span class="text-xs text-slate-400 block tracking-wider">BET</span>
                                <span id="currentBet" class="text-2xl text-amber-400 font-bold">10</span>
                            </div>
                            <button onclick="adjustBet(10)" class="w-12 h-12 rounded-full bg-slate-700 hover:bg-slate-600 flex items-center justify-center font-bold text-2xl">+</button>
                        </div>
                    </div>

                    <!-- Action Button -->
                    <button id="mainActionBtn" onclick="handleAction()" class="btn-primary w-full py-4 rounded-lg text-2xl font-bold tracking-widest shadow-xl">ROLL DICE</button>
                </div>
            </div>

            <!-- Side Panel (History) -->
            <div id="sidePanel" class="hidden lg:flex flex-col w-80 bg-black/60 backdrop-blur-md border border-white/10 rounded-xl overflow-hidden shadow-2xl shrink-0">
                <div class="bg-black/40 p-3 border-b border-white/10 text-center">
                    <span class="text-amber-400 font-bold tracking-wider text-sm">ROUND HISTORY</span>
                </div>
                <div id="historyContent" class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2">
                    <!-- History Items -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Game Logic ---
        const config = {
            startingCredits: 100,
            tableColor: 'green'
        };

        const state = {
            mode: 'menu', // menu, single, coop
            phase: 'betting', // betting, player_roll, banker_roll, resolve
            credits: [100, 100],
            bet: 10,
            dice: [4, 5, 6],
            currentPlayer: 1, // 1 or 2 (Banker is technically player 2 in single)
            hands: [null, null], // Store results { rank, value, type }
            history: []
        };

        // DOM Elements
        const els = {
            mainMenu: document.getElementById('mainMenu'),
            gameUI: document.getElementById('gameUI'),
            diceContainer: document.getElementById('diceContainer'),
            opponentArea: document.getElementById('opponentArea'),
            opponentDice: document.getElementById('opponentDice'),
            betControls: document.getElementById('betControls'),
            currentBet: document.getElementById('currentBet'),
            mainActionBtn: document.getElementById('mainActionBtn'),
            gameStatus: document.getElementById('gameStatus'),
            gameResult: document.getElementById('gameResult'),
            scoreDisplay: document.getElementById('scoreDisplay'),
            modeDisplay: document.getElementById('modeDisplay'),
            historyContent: document.getElementById('historyContent'),
            confettiCanvas: document.getElementById('confettiCanvas'),
            settingsModal: document.getElementById('settingsModal'),
            matchWinModal: document.getElementById('matchWinModal'),
            vsPanel: document.getElementById('vsPanel'),
            p1ScoreBoard: document.getElementById('p1ScoreBoard'),
            p2ScoreBoard: document.getElementById('p2ScoreBoard'),
            p2Label: document.getElementById('p2Label')
        };

        // --- Init ---
        function init() {
            setTableColor('green');
            renderDice([4, 5, 6], els.diceContainer);
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
        }

        function setTableColor(color) {
            config.tableColor = color;
            document.body.classList.remove('theme-green', 'theme-blue', 'theme-red', 'theme-purple', 'theme-black');
            document.body.classList.add(`theme-${color}`);
        }

        function toggleSettings() {
            els.settingsModal.classList.toggle('hidden');
        }

        function startGame(mode) {
            state.mode = mode;
            state.credits = (mode === 'single') ? [100, 10000] : [100, 100]; // P2 in single is Bank (infiniteish)
            state.history = [];
            
            els.mainMenu.classList.add('hidden');
            els.gameUI.classList.remove('hidden');
            
            if (mode === 'single') {
                els.modeDisplay.innerText = "VS BANKER";
                els.p2Label.innerText = "BANKER";
                els.opponentArea.classList.remove('hidden');
            } else {
                els.modeDisplay.innerText = "2 PLAYER BATTLE";
                els.p2Label.innerText = "PLAYER 2";
                els.opponentArea.classList.add('hidden');
            }
            
            resetRound();
        }

        function quitGame() {
            els.gameUI.classList.add('hidden');
            els.mainMenu.classList.remove('hidden');
            els.matchWinModal.classList.add('hidden');
        }

        function resetRound() {
            state.phase = 'betting';
            state.currentPlayer = 1;
            state.hands = [null, null];
            
            // Check Bankruptcy
            if (state.credits[0] <= 0) {
                state.phase = 'gameover';
                setStatus("GAME OVER", "Out of Cash!");
                els.mainActionBtn.innerText = "MENU";
                return;
            }

            // Reset UI
            state.dice = [1, 2, 3];
            renderDice(state.dice, els.diceContainer);
            renderDice([1,1,1], els.opponentDice); // Dummy render
            els.opponentDice.style.opacity = '0.3';
            
            els.betControls.classList.remove('hidden');
            els.mainActionBtn.innerText = "ROLL TO START";
            els.mainActionBtn.disabled = false;
            
            // Reset VS Panel
            els.vsPanel.classList.add('opacity-0');
            setTimeout(() => {
                els.p1ScoreBoard.innerText = "WAITING";
                els.p1ScoreBoard.className = "vs-score text-slate-500";
                els.p2ScoreBoard.innerText = "WAITING";
                els.p2ScoreBoard.className = "vs-score text-slate-500";
            }, 300);

            state.bet = Math.min(state.bet, state.credits[0]);
            if (state.bet < 10 && state.credits[0] >= 10) state.bet = 10;
            if (state.bet > state.credits[0]) state.bet = state.credits[0];
            
            updateUI();
            setStatus("PLACE BET", "");
        }

        function adjustBet(amount) {
            if (state.phase !== 'betting') return;
            const newBet = state.bet + amount;
            if (newBet >= 10 && newBet <= state.credits[0]) {
                state.bet = newBet;
                updateUI();
            }
        }

        function handleAction() {
            if (state.phase === 'gameover') {
                quitGame();
                return;
            }

            if (state.phase === 'betting') {
                // Lock bet
                state.phase = 'player_roll';
                els.betControls.classList.add('hidden');
                
                // Show VS Panel
                els.vsPanel.classList.remove('opacity-0');
                
                setStatus(state.mode === 'single' ? "PLAYER ROLL" : "PLAYER 1 ROLL", "");
                rollDice(1);
            } else if (state.phase === 'player_roll') {
                // This state is usually automated unless "Roll Again" is needed
                rollDice(state.currentPlayer);
            } else if (state.phase === 'resolve') {
                resetRound();
            }
        }

        function updateUI() {
            els.currentBet.innerText = state.bet;
            if (state.mode === 'single') {
                els.scoreDisplay.innerText = `CREDITS: ${state.credits[0]}`;
            } else {
                els.scoreDisplay.innerHTML = `<span class="text-amber-400">P1: ${state.credits[0]}</span> <span class="text-slate-500 mx-2">|</span> <span class="text-blue-400">P2: ${state.credits[1]}</span>`;
            }
        }

        function setStatus(top, main) {
            els.gameStatus.innerText = top;
            els.gameResult.innerHTML = main;
        }

        function rollDice(playerIdx) {
            els.mainActionBtn.disabled = true;
            els.mainActionBtn.innerText = "ROLLING...";
            
            // Animation
            const container = (playerIdx === 1) ? els.diceContainer : els.opponentDice;
            const diceDivs = container.children;
            for(let d of diceDivs) d.classList.add('rolling');
            
            if (playerIdx === 2) {
                els.opponentDice.style.opacity = '1';
                els.p2ScoreBoard.innerText = "ROLLING...";
                els.p2ScoreBoard.classList.add('animate-pulse');
            } else {
                els.p1ScoreBoard.innerText = "ROLLING...";
                els.p1ScoreBoard.classList.add('animate-pulse');
            }

            setTimeout(() => {
                // Generate
                const result = [r(), r(), r()];
                state.dice = result;
                
                for(let d of diceDivs) d.classList.remove('rolling');
                
                // Eval
                const hand = evaluateHand(result);
                
                // Render with highlighting
                if (playerIdx === 1) {
                    renderDice(result, els.diceContainer, hand);
                } else {
                    renderDice(result, els.opponentDice, hand);
                }

                // Stop text pulse
                if (playerIdx === 1) els.p1ScoreBoard.classList.remove('animate-pulse');
                else els.p2ScoreBoard.classList.remove('animate-pulse');
                
                if (hand.type === 'junk') {
                    // Junk - Re-roll
                    setStatus(playerIdx === 1 ? "ROLLED JUNK" : "BANKER ROLLED JUNK", "Roll Again...");
                    els.mainActionBtn.innerText = "RE-ROLL";
                    els.mainActionBtn.disabled = false;
                    
                    if(playerIdx === 1) els.p1ScoreBoard.innerText = "JUNK";
                    else els.p2ScoreBoard.innerText = "JUNK";
                    
                    // Auto-roll for Bank
                    if (state.mode === 'single' && playerIdx === 2) {
                         setTimeout(() => rollDice(2), 1000);
                    }
                } else {
                    // Valid Hand
                    state.hands[playerIdx - 1] = hand;
                    const handName = getHandName(hand);
                    
                    // Update VS Panel Prominently
                    const targetEl = playerIdx === 1 ? els.p1ScoreBoard : els.p2ScoreBoard;
                    targetEl.innerText = handName;
                    targetEl.className = "vs-score active-score"; // Gold and big
                    
                    setStatus(playerIdx === 1 ? "HAND SET" : "BANKER HAND", getBadgeHTML(hand));

                    if (playerIdx === 1) {
                        // Check instant Win/Loss
                        if (hand.type === '456') {
                            endRound(1); // Player 1 Wins
                        } else if (hand.type === '123') {
                            endRound(2); // Player 1 Loses (P2 wins)
                        } else {
                            // Valid Point/Trips - Next Turn
                            if (state.mode === 'single') {
                                state.phase = 'banker_roll';
                                state.currentPlayer = 2;
                                setTimeout(() => rollDice(2), 1500);
                            } else {
                                // Coop Player 2
                                els.mainActionBtn.disabled = false;
                                els.mainActionBtn.innerText = "START PLAYER 2";
                                state.currentPlayer = 2;
                                setStatus("PLAYER 1 DONE", "Player 2's Turn");
                                // Wait for click
                            }
                        }
                    } else {
                        // Player 2 (or Bank) finished
                        endRound(); // Comparison
                    }
                }
            }, 600);
        }

        function endRound(forcedWinner = null) {
            state.phase = 'resolve';
            els.mainActionBtn.disabled = false;
            els.mainActionBtn.innerText = "NEXT ROUND";
            
            let p1 = state.hands[0];
            let p2 = forcedWinner ? null : state.hands[1];
            let winner = 0; // 0=tie, 1=p1, 2=p2
            
            if (forcedWinner) {
                winner = forcedWinner;
            } else {
                if (p1.score > p2.score) winner = 1;
                else if (p2.score > p1.score) winner = 2;
                else winner = 0;
            }

            let msg = "";
            let amount = state.bet;

            if (winner === 1) {
                msg = state.mode === 'single' ? `<span class="text-green-400">YOU WIN!</span>` : `<span class="text-amber-400">PLAYER 1 WINS!</span>`;
                state.credits[0] += amount;
                if (state.mode !== 'single') state.credits[1] -= amount;
                els.p1ScoreBoard.classList.add('text-green-400');
                if(!forcedWinner) els.p2ScoreBoard.classList.add('text-red-400');
                spawnConfetti();
            } else if (winner === 2) {
                msg = state.mode === 'single' ? `<span class="text-red-400">BANKER WINS</span>` : `<span class="text-blue-400">PLAYER 2 WINS!</span>`;
                state.credits[0] -= amount;
                if (state.mode !== 'single') state.credits[1] += amount;
                els.p1ScoreBoard.classList.add('text-red-400');
                if(!forcedWinner) els.p2ScoreBoard.classList.add('text-green-400');
            } else {
                msg = `<span class="text-slate-300">PUSH (TIE)</span>`;
            }
            
            // Add History
            const p1Str = p1 ? `${p1.type === 'point' ? 'Pt ' + p1.value : p1.type}` : '-';
            const p2Str = p2 ? `${p2.type === 'point' ? 'Pt ' + p2.value : p2.type}` : (forcedWinner === 1 ? 'Auto Loss' : '-');
            
            addToHistory(winner, p1Str, p2Str, amount);
            
            els.gameResult.innerHTML = msg;
            updateUI();
        }

        function addToHistory(winner, h1, h2, amt) {
            const div = document.createElement('div');
            div.className = "bg-slate-800/50 p-2 rounded text-xs flex justify-between items-center border border-white/5";
            
            let wText = "TIE";
            let color = "text-slate-400";
            if (winner === 1) { wText = "P1 WIN"; color = "text-green-400"; }
            if (winner === 2) { wText = state.mode==='single' ? "BANK WIN" : "P2 WIN"; color = "text-red-400"; }
            
            div.innerHTML = `
                <div>
                    <span class="font-bold ${color}">${wText}</span>
                    <span class="text-slate-500 ml-2">${h1} vs ${h2}</span>
                </div>
                <div class="font-mono text-amber-500">${amt}</div>
            `;
            
            els.historyContent.prepend(div);
        }

        // Cee-Lo Rules
        function evaluateHand(dice) {
            const s = [...dice].sort((a,b)=>a-b).join('');
            
            // 4-5-6 (All Highlight)
            if (s === '456') return { type: '456', score: 1000, value: 0, highlights: [0,1,2], color:'green' };
            
            // 1-2-3 (All Highlight Bad)
            if (s === '123') return { type: '123', score: 0, value: 0, highlights: [0,1,2], color:'red' };
            
            // Trips (All Highlight)
            if (dice[0] === dice[1] && dice[1] === dice[2]) {
                return { type: 'trips', score: 100 + dice[0], value: dice[0], highlights: [0,1,2], color:'gold' };
            }
            
            // Point (Highlight the single)
            // Note: input dice array is NOT sorted, but 's' string is sorted.
            // We need original indices for highlighting.
            
            // Find counts
            const counts = {};
            dice.forEach(d => counts[d] = (counts[d] || 0) + 1);
            
            let pairVal = null;
            let pointVal = null;
            let pointIdx = -1;
            
            for (const [val, count] of Object.entries(counts)) {
                if (count === 2) pairVal = parseInt(val);
                if (count === 1) pointVal = parseInt(val);
            }
            
            if (pairVal !== null && pointVal !== null) {
                // Find index of point
                pointIdx = dice.indexOf(pointVal);
                return { type: 'point', score: pointVal, value: pointVal, highlights: [pointIdx], color:'gold' };
            }
            
            // Junk
            return { type: 'junk', score: -1, value: 0, highlights: [], color:'' };
        }
        
        function getHandName(hand) {
            if (hand.type === '456') return '4-5-6';
            if (hand.type === '123') return '1-2-3';
            if (hand.type === 'trips') return `TRIPS ${hand.value}s`;
            if (hand.type === 'point') return `POINT ${hand.value}`;
            return 'JUNK';
        }

        function getBadgeHTML(hand) {
            let cls = '';
            let txt = '';
            if (hand.type === '456') { cls = 'badge-456'; txt = '4 - 5 - 6'; }
            else if (hand.type === '123') { cls = 'badge-123'; txt = '1 - 2 - 3'; }
            else if (hand.type === 'trips') { cls = 'badge-trips'; txt = `TRIPS ${hand.value}s`; }
            else if (hand.type === 'point') { cls = 'badge-point'; txt = `POINT ${hand.value}`; }
            
            return `<span class="px-4 py-1 rounded-full text-lg font-bold ${cls}">${txt}</span>`;
        }

        function r() { return Math.floor(Math.random() * 6) + 1; }

        // --- Render ---
        function renderDice(values, container, handResult = null) {
            container.innerHTML = values.map((v, idx) => {
                let classes = "die";
                if (handResult) {
                    if (handResult.highlights.includes(idx)) {
                        // Scoring Die
                        if (handResult.color === 'green') classes += " highlight-green";
                        else if (handResult.color === 'red') classes += " highlight-red";
                        else classes += " highlight-gold";
                    } else {
                        // Junk/Pair Die
                        classes += " dimmed";
                    }
                }
                return `<div class="${classes}"><div class="face-${v} w-full h-full">${getDots(v)}</div></div>`;
            }).join('');
        }

        function getDots(n) {
            return Array(n).fill('<div class="dot"></div>').join('');
        }

        // --- Confetti ---
        const canvas = els.confettiCanvas;
        const ctx = canvas.getContext('2d');
        let particles = [];
        let animationId = null;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = -10;
                this.vx = (Math.random() - 0.5) * 4;
                this.vy = Math.random() * 4 + 2;
                this.color = `hsl(${Math.random() * 360}, 100%, 50%)`;
                this.size = Math.random() * 8 + 4;
            }
            update() {
                this.x += this.vx;
                this.y += this.vy;
                return this.y < canvas.height;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, this.size, this.size);
            }
        }

        function spawnConfetti() {
            particles = Array(100).fill().map(() => new Particle());
            if (!animationId) animate();
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles = particles.filter(p => p.update());
            particles.forEach(p => p.draw());
            if (particles.length) requestAnimationFrame(animate);
            else animationId = null;
        }

        init();
    </script>
</body>
</html>